<mat-toolbar>
  <span>Sclipi Web</span>
  <mat-divider vertical></mat-divider>
  @if (idn.data(); as data) {
    <span class="subtitle" [matTooltip]="idn.formatted()" matTooltipClass="tooltip" matTooltipPosition="right">{{data.model}} - {{data.serial}}</span>
  }
  <span class="toolbar-spacer"></span>

  <mat-button-toggle-group name="operation-mode-buttons" [(ngModel)]="preferences.operationMode">
    <mat-button-toggle value="interactive" matTooltip="Manually input commands" [disabled]="sending$ | async">Interactive</mat-button-toggle>
    <mat-button-toggle value="scripted" matTooltip="Load/run predefined lists of commands" [disabled]="sending$ | async">Scripts</mat-button-toggle>
  </mat-button-toggle-group>

  <span class="toolbar-spacer"></span>

  <mat-button-toggle-group name="toolbar-buttons" [(ngModel)]="activeToolbarButtons" multiple hideMultipleSelectionIndicator>
    <mat-button-toggle value="idn" matTooltip="Info"><mat-icon>info</mat-icon></mat-button-toggle>
    <mat-button-toggle value="settings" matTooltip="Preferences"><mat-icon>settings</mat-icon></mat-button-toggle>
  </mat-button-toggle-group>
</mat-toolbar>
<div class="content">
  <div class="main">
    @if (preferences.operationMode() === 'scripted') {
      <div class="script-header">
        <div class="script-inputs">
          <div class="script-load-buttons">
            <button matFab extended (click)="selectScriptFromFile()" [disabled]="scriptRunning()"><mat-icon>file_open</mat-icon>Load from File</button>
            <input #fileInput type="file" (change)="onFileSelected($event)" style="display: none" />

            <button matFab extended (click)="selectScriptFromClipboard()" [disabled]="scriptRunning()"><mat-icon>content_paste</mat-icon>Paste from Clipboard</button>
          </div>

          <div class="loaded-script-info">
            @if (script().length > 0) {
              <div>
                <mat-icon>numbers</mat-icon>
                <span>{{script().length}} {{script().length === 1 ? 'command' : 'commands'}}</span>
              </div>
              <div matTooltip="Origin of loaded script">
                <mat-icon>{{scriptSource() === 'file' ? 'article' : 'content_paste'}}</mat-icon>
                <span>{{scriptSource() === 'file' ? scriptFileName() : 'clipboard'}}</span>
              </div>
            }
          </div>

          @if (script().length > 0) {
            <mat-divider vertical></mat-divider>
          }

          <div class="run-script-controls">
            @if (script().length > 0) {
              <button matFab extended (click)="runScript()" [disabled]="scriptRunning()">
                @if (scriptRunning()) {
                  <mat-icon>play_disabled</mat-icon>
                } @else {
                  <mat-icon>play_circle</mat-icon>
                }
                @if (scriptRunning()) {
                  Running...
                } @else {
                  Run Script
                }
              </button>
            }
            @if (scriptRunning()) {
              <button matFab extended (click)="scriptCancelled.set(true)" [disabled]="scriptCancelled()"><mat-icon>stop_circle</mat-icon>
                @if (scriptCancelled()) {
                  Aborting...
                } @else {
                  Abort
                }
              </button>
            }
          </div>
        </div>

        <div class="script-progress">
          @if (scriptRunning()) {
            <mat-progress-bar mode="determinate" [value]="scriptProgressPercentage()"></mat-progress-bar>
          }
        </div>
      </div>
    } @else {
      <div class="inputs">
        <div class="start-keys">
          <button matMiniFab (click)="insertCharacter(':')" [disabled]="inputText().length > 1" matTooltip="Start common command" matTooltipPosition="above">:</button>
          <button matMiniFab (click)="insertCharacter('*')" [disabled]="inputText().length > 1" matTooltip="Start subsystem command" matTooltipPosition="below">*</button>
        </div>
        <mat-form-field appearance="outline" class="scpi-form">
          <mat-label>SCPI Command/Query</mat-label>
          <input
            type="text"
            #scpiInput
            [(ngModel)]="inputText"
            autofocus
            (keydown)="onInputKeydown($event)"
            (keydown.enter)="sendInteractive()"
            matInput
            [autocomplete]="auto"
            #autocompleteRef="autocompleteTrigger"
            [valueTransform]="autocompleteValueTransform"
          />
          <mat-hint>Type <strong>:</strong> or <strong>*</strong> for auto-complete. <strong>Arrow Up</strong> for history. <strong>Enter</strong> to submit.</mat-hint>
          <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete" hideSingleSelectionIndicator>
            @if (inputText().length !== 0 && history.index() < 0) {
              <!-- TODO: better track -->
              @for (option of autocomplete(); track $index) {
                <mat-option [value]="option">
                  @if (typeof option === 'string') {
                    {{ option }}
                  } @else {
                    {{ getDisplayValue(option) }}
                  }
                  <mat-icon>
                    @if (typeof option === 'string') {
                      @if (option.endsWith('?')) {
                        question_mark
                      }
                    } @else {
                      @if ((!option.children || option.children.length === 0)) {
                        @if (option.content.text.endsWith('?')) {
                          question_mark
                        } @else {
                          play_arrow
                        }
                      }
                    }
                  </mat-icon>
                </mat-option>
              }
            }
          </mat-autocomplete>
        </mat-form-field>
        <button
          class="send-button"
          matFab extended
          (click)="sendInteractive()"
          [disabled]="inputText().length === 0 || (sending$ | async)"
        >
          @if (sending$ | async) {
            <mat-icon>schedule_send</mat-icon>
          } @else {
            <mat-icon>send</mat-icon>
          }
          Send
        </button>
        <button
          matFab extended
          matTooltip="Send :SYST:ERR? query to check for errors"
          matTooltipPosition="above"
          (click)="systErr()"
          [disabled]="inputText().length !== 0 || (sending$ | async)"
        >
          <mat-icon>question_mark</mat-icon>
          :SYST:ERR?
        </button>
        <button
          matFab extended
          matTooltip="Select and run a command from your command history"
          matTooltipPosition="above"
          [matMenuTriggerFor]="menu"
          [disabled]="history.list().length === 0 || inputText().length !== 0 || (sending$ | async)"
        >
          <mat-icon>history</mat-icon>
          <mat-icon>arrow_drop_down</mat-icon>
          History
        </button>
        <mat-menu #menu="matMenu" class="history-menu">
          @if (history.list().length > 0) {
            <button mat-menu-item (click)="history.list.set([])">
              <mat-icon>delete</mat-icon>
              Clear History
            </button>
            <mat-divider></mat-divider>
          }
          @for (option of history.list(); track $index) {
            <button (click)="onHistoryEntrySelect(option)" mat-menu-item>
              <mat-icon>
                @if (option.includes('?')) {
                  question_mark
                } @else {
                  play_arrow
                }
              </mat-icon>
              {{ option }}
            </button>
          }
        </mat-menu>
      </div>
    }

    @if (log().length > 0 || forceShowLog()) {
      <div class="log-section">
        <div #logContainer class="log" [class.wrap]="preferences.wrapLog()" (scroll)="onLogScroll()">
          @for (entry of log(); track entry.uniqueId; let i = $index) {
            <div #entry class="entry"
              [class.selected]="selectedLogIndices().includes(i)"
              (mousedown)="onEntryMouseDown(i, $event)"
              (mouseenter)="onEntryMouseEnter(i)"
              (click)="onEntryClick(i)">
              <div class="timestamp-container">
                @if (preferences.showDate()) {
                  <span class="timestamp" [matTooltip]="entry.elapsed | date: 's.SSS \'s\''" [class.hidden]="!!entry.hideTime">
                    {{ entry.time | date: 'MMM dd, hh:mm:ss.SS a' }}
                  </span>
                } @else {
                  <span class="timestamp" [matTooltip]="entry.elapsed | date: 's.SSS \'s\''" [class.hidden]="!!entry.hideTime">
                    {{ entry.time | date: 'hh:mm:ss.SS a' }}
                  </span>
                }

                @if (!!entry.hideTime) {
                  <mat-icon>subdirectory_arrow_right</mat-icon>
                }
              </div>
              <div class="scpi"><b>{{ entry.scpi }}</b></div>
              @if (i === log().length - 1 && (showSlowSendIndicator$ | async)) {

                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              }
              @if (entry.minimized) {
                <pre>{{ entry.response?.split('\n')?.[0]?.slice(0, 30) }}</pre>
                <span class="collapsed">... response collapsed ...</span>
                <mat-icon class="collapsed">compress</mat-icon>
              } @else {
                <pre [class.serverError]="entry.isServerError">{{ entry.response }}</pre>
              }
              @if (selectedLogIndices().length > 0 && selectedLogIndices()[0] === i) {
                <div class="hover-buttons">
                  <button
                    matMiniFab
                    [matTooltip]="selectedLogIndices().length === 1
                      ? (log()[selectedLogIndices()[0]].scpi.includes('?') ? 'Resend this query' : 'Resend this command')
                      : 'Resend selected commands'"
                    (click)="sendSelectedCommands()"
                    [disabled]="sending$ | async"
                  >
                    <mat-icon>send</mat-icon>
                  </button>

                  <button matMiniFab matTooltip="Copy" (click)="copySelectedCommands()"><mat-icon>content_copy</mat-icon></button>
                  @if (selectedLogIndices().length === 1) {
                    @if (entry.minimized) {
                      <button matMiniFab matTooltip="Expand" (click)="maximizeSelectedEntry()"><mat-icon>expand</mat-icon></button>
                    } @else {
                      <button matMiniFab matTooltip="Collapse" (click)="minimizeSelectedEntry()"><mat-icon>compress</mat-icon></button>
                    }
                  }
                </div>
              }
            </div>
          }
        </div>

        <div class="left-log-buttons">
          <button matMiniFab matTooltip="Scroll to top" matTooltipPosition="right" (click)="scrollToTop()" [disabled]="isScrolledToTop()">
            <mat-icon>vertical_align_top</mat-icon>
          </button>
          <button matMiniFab matTooltip="Scroll to bottom" matTooltipPosition="right" (click)="scrollToBottom()" [disabled]="isScrolledToBottom()">
            <mat-icon>vertical_align_bottom</mat-icon>
          </button>
          <button matMiniFab matTooltip="Select previous" matTooltipPosition="right"
            [disabled]="log().length === 0 || (selectedLogIndices().length > 0 && selectedLogIndices()[0] === 0)"
            (click)="previousLogEntry()">
            <mat-icon>arrow_upward</mat-icon>
          </button>
          <button matMiniFab matTooltip="Select next" matTooltipPosition="right"
            [disabled]="log().length === 0 || (selectedLogIndices().length > 0 && selectedLogIndices()[selectedLogIndices().length - 1] >= log().length - 1)"
            (click)="nextLogEntry()">
            <mat-icon>arrow_downward</mat-icon>
          </button>
        </div>
        <div class="right-log-buttons">
          <button matMiniFab class="wide-mini-fab-button" matTooltip="Copy log" matTooltipPosition="right" [matMenuTriggerFor]="copyMenu" [disabled]="log().length === 0">
            <mat-icon>arrow_drop_down</mat-icon>
            <mat-icon>copy_all</mat-icon>
          </button>
          <mat-menu #copyMenu="matMenu">
              <button (click)="copyFullLog()" mat-menu-item>
                Copy Full Log
              </button>
              <button (click)="copyCommands()" mat-menu-item>
                Copy Command List
              </button>
          </mat-menu>

          <button matMiniFab class="wide-mini-fab-button" matTooltip="Download log" matTooltipPosition="right" [matMenuTriggerFor]="downloadMenu" [disabled]="log().length === 0">
            <mat-icon>arrow_drop_down</mat-icon>
            <mat-icon>download</mat-icon>
          </button>
          <mat-menu #downloadMenu="matMenu">
              <button (click)="downloadFullLog()" mat-menu-item>
                Download Full Log
              </button>
              <button (click)="downloadCommands()" mat-menu-item>
                Download Command List
              </button>
          </mat-menu>

          <button matMiniFab matTooltip="Clear log" matTooltipPosition="right" (click)="clearLog()" [disabled]="log().length === 0">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    }
  </div>

  @if (activeToolbarButtons().length > 0) {
    <div class="right-panel">
      <div class="right-panel-background">
        <div class="right-panel-content">
          @if (activeToolbarButtons().includes('idn')) {
            @if (health.hasValue() && !health.value()) {
              <div>Health: Not OK!</div>
            }

            <h2>Info</h2>
            @if (idn.data(); as data) {
              <div class="idn">
                <b>Manufacturer:</b> {{data.manufacturer}}<br>
                <b>Model:</b> {{data.model}}<br>
                <b>Serial:</b> {{data.serial}}<br>
                <b>Version:</b> {{data.version}}<br>
              </div>
            } @else {
              @if (idn.error()) {
                <span>IDN Error: {{ idn.error()?.error }}</span>
              }
              <span>Connection failed. Check your Server Preferences</span>
            }
          }

          @if (activeToolbarButtons().includes('idn') && activeToolbarButtons().includes('settings')) {
            <mat-divider></mat-divider>
          }

          @if (activeToolbarButtons().includes('settings')) {
            <app-preferences></app-preferences>
          }
        </div>
      </div>
    </div>
  }
</div>

