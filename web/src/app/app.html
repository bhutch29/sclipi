<div class="main">
  <div class="inputs">
    <mat-form-field class="scpi-form">
      <input
        type="text"
        #scpiInput
        [(ngModel)]="inputText"
        autofocus
        (keydown.enter)="send()"
        (keydown.arrowUp)="arrowUp($event)"
        (keydown.arrowDown)="arrowDown($event)"
        placeholder="Type colon ':' to start. Enter to submit. Arrow up for history."
        matInput
        [matAutocomplete]="auto"
      />
      <mat-autocomplete autoActiveFirstOption autoSelectActiveOption #auto="matAutocomplete">
        @if (inputText().length !== 0) {
          @for (option of autocompleteHistory(); track option) {
            <mat-option [value]="option">{{ option }}</mat-option>
          }
        }
      </mat-autocomplete>
    </mat-form-field>
    <button matButton="tonal" (click)="send()" [disabled]="inputText().length === 0 || (sending$ | async)">Send</button>
    <button matButton="tonal" (click)="systErr()" [disabled]="inputText().length !== 0 || (sending$ | async)">:SYST:ERR?</button>
    @if (showSlowSendIndicator$ | async) {
      <div>...</div>
    }
  </div>

  <div class="log" [class.wrap]="preferences.wrapLog()">
    @for (entry of log(); track entry.time) {
      <div class="entry">
        @if (preferences.showDate()) {
          <span class="timestamp">{{ entry.time | date: 'MMM dd, hh:mm:ss a' }}</span>
        } @else {
          <span class="timestamp">{{ entry.time | date: 'hh:mm:ss a' }}</span>
        }
        <b>{{ entry.scpi }}</b>
        {{ entry.response }}
        {{ entry.serverError }}
        <!-- TODO: fix track -->
        @for (error of entry.errors; track error) {
          {{ error }}
        }
      </div>
    }
  </div>
</div>

<div class="right-panel">
  @if (health.hasValue() && !health.value()) {
    <div>Health: Not OK!</div>
  }

  @if (idnFormatted()) {
    <div class="idn" [innerHtml]="idnFormatted()"></div>
  } @else if (idnError()) {
    IDN Error: {{ idnError()?.error }}
  }

  @if (error()) {
    Error: {{ error() }}
  }

  <button (click)="clearHistory()">Clear History</button>
  <app-preferences></app-preferences>
</div>
