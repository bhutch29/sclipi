<div class="main">
  <div class="inputs">
    <mat-form-field class="scpi-form">
      <input
        type="text"
        #scpiInput
        [(ngModel)]="inputText"
        autofocus
        (keydown.enter)="send()"
        (keydown.arrowUp)="arrowUp($event)"
        (keydown.arrowDown)="arrowDown($event)"
        placeholder="Type colon ':' to start. Enter to submit. Arrow up for history."
        matInput
        [matAutocomplete]="auto"
      />
      <mat-autocomplete autoActiveFirstOption autoSelectActiveOption #auto="matAutocomplete">
        @if (inputText().length !== 0) {
          @for (option of autocompleteHistory(); track option) {
            <mat-option [value]="option">{{ option }}</mat-option>
          }
        }
      </mat-autocomplete>
    </mat-form-field>
    <button matButton="tonal" (click)="send()" [disabled]="inputText().length === 0 || (sending$ | async)">Send</button>
    <button matButton="tonal" (click)="systErr()" [disabled]="inputText().length !== 0 || (sending$ | async)">:SYST:ERR?</button>
    @if (showSlowSendIndicator$ | async) {
      <div>...</div>
    }
  </div>

  <div class="log" [ngClass]="{ wrap: wrapLog() }">
    @for (entry of log(); track entry.time) {
      <div class="entry">
        {{ entry.time | date: 'medium' }}
        {{ entry.scpi }}
        {{ entry.response }}
        {{ entry.serverError }}
        <!-- TODO: fix track -->
        @for (error of entry.errors; track error) {
          {{ error }}
        }
      </div>
    }
  </div>
</div>

<div class="right-panel">
  @if (health.hasValue() && !health.value()) {
    <div>Health: Not OK!</div>
  }

  @if (idnFormatted()) {
    <div class="idn" [innerHtml]="idnFormatted()"></div>
  } @else if (idnError()) {
    IDN Error: {{ idnError()?.error }}
  }

  @if (error()) {
    Error: {{ error() }}
  }

  <div class="options">
    <div class="client-options">
      <label>
        <input type="checkbox" [(ngModel)]="simulated" />
        Simulated
      </label>
      <label>
        <input type="checkbox" [(ngModel)]="wrapLog" />
        Wrap Log
      </label>
      <label>
        <input type="checkbox" [(ngModel)]="autoSystErr" />
        Auto :SYST:ERR?
      </label>
      <label>
        <input type="number" [(ngModel)]="timeoutSeconds" />
        Timeout (seconds)
      </label>
      <button (click)="resetClientPreferences()">Reset client preferences to default</button>
      <button (click)="clearHistory()">Clear History</button>
    </div>
    <div class="server-options">
      <label>
        <input
          type="number"
          [(ngModel)]="port"
          (blur)="onPortBlur()"
          (keydown.enter)="onPortEnter($event)"
        />
        SCPI Socket Port
      </label>
      <label>
        <input
          type="text"
          [(ngModel)]="address"
          (blur)="onAddressBlur()"
          (keydown.enter)="onAddressEnter($event)"
        />
        SCPI Socket Address
      </label>
      <button (click)="resetServerPreferences()">Reset server preferences to default</button>
    </div>
  </div>
</div>
